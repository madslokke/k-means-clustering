<html lang="da">
<head>

  <title>K-means clustering</title>
  <style>
      canvas {
          display: block;
          margin: 10px auto;
          border: 1px solid black;
      }
  </style>
</head>
<body>

<div style="display: flex; justify-content: space-evenly;">
  <div style="display: flex; flex-direction: column">
    <label for="data">Data fx 1;1</label>
    <textarea cols="10" rows="20" id="data">
3.199813;5.384308;1
3.544642;9.740232;1
0.939381;4.374027;1
3.150614;-2.665555;1
2.114686;-1.316104;1
3.548620;5.986773;1
2.104111;3.154852;1
1.184435;-1.458748;1
1.155879;5.180366;1
1.825293;8.083018;1
0.790573;-5.091748;1
-0.500091;1.271134;1
0.048074;-3.618499;1
2.952004;3.212990;1
0.909006;6.119488;1
0.425307;-2.803413;1
1.026187;-1.110289;1
2.343718;6.632263;1
2.601782;6.488877;1
2.975857;-1.269020;1
1.860207;4.689227;1
3.632516;5.405081;1
1.294167;3.892867;1
1.950114;3.415384;1
0.646268;5.276686;1
0.666938;6.773280;1
3.733387;-1.995729;1
3.124350;1.274108;1
3.136891;3.400511;1
1.229762;2.158642;1
1.311017;-0.022499;1
2.236815;2.596178;1
3.423961;2.389827;1
2.717430;4.973968;1
2.354173;3.438872;1
0.212679;2.993352;1
0.892802;1.204356;1
2.291981;-0.208040;1
3.134398;4.486906;1
2.367867;-1.748017;1
3.189611;-0.099912;1
1.537833;3.884043;1
1.052656;3.785656;1
-0.666227;1.643572;1
3.413357;2.884065;1
0.823126;2.943939;1
0.593722;-1.116674;1
2.374360;5.032669;1
1.626991;4.137871;1
2.540321;-0.008299;1
0.218688;0.155430;1
1.281014;0.226605;1
2.632079;2.320032;1
0.970519;0.216377;1
3.574547;-1.171900;1
0.936812;3.996251;1
2.387605;1.616616;1
1.109707;3.671207;1
-0.017475;1.698323;1
2.042582;3.909064;1
3.142093;8.260459;1
1.660082;8.044121;1
0.304182;-0.369533;1
2.225604;3.871621;1
1.302497;-2.055588;1
-0.467531;-0.332538;1
2.977736;1.523529;1
1.000132;1.590597;1
1.251568;-4.175014;1
0.307498;6.808645;1
3.882857;2.891976;1
2.483234;-1.258005;1
0.031005;-0.654323;1
1.243028;0.726238;1
2.649297;-2.330998;1
1.591883;3.766419;1
2.359585;1.507296;1
3.541595;7.914839;1
2.770566;8.022516;1
4.010238;1.301056;1
0.681123;-1.399559;1
1.831836;5.328822;1
1.085500;0.219880;1
2.372271;7.407900;1
1.316104;-3.110969;1
2.367601;-3.325297;1
3.868594;2.914013;1
4.267215;5.781862;1
1.641917;3.537324;1
2.377782;0.665094;1
1.412584;1.264841;1
1.715039;3.528207;1
1.318499;-2.875498;1
2.259838;-3.330749;1
1.721046;5.069751;1
2.240669;-0.110285;1
1.737908;-1.153402;1
1.870642;6.645838;1
2.395947;6.568175;1
1.432108;-0.661641;1
3.819085;7.871540;2
4.839429;7.507983;2
5.222917;3.000808;2
5.266054;7.399522;2
5.158536;8.006475;2
4.919864;8.496726;2
4.615720;8.126842;2
4.927254;6.358913;2
5.206027;10.415754;2
4.793226;8.941107;2
4.381379;5.168658;2
5.326447;6.613559;2
4.748659;8.383345;2
5.672733;4.423870;2
4.816674;6.002447;2
4.141890;8.993285;2
4.598180;3.911900;2
5.111649;6.322199;2
4.696189;6.944993;2
4.198838;11.857692;2
4.572667;8.795842;2
5.780050;14.215032;2
5.764746;4.176731;2
5.230544;9.563134;2
4.528029;8.181631;2
4.415351;8.057693;2
5.359615;9.513467;2
4.069913;9.366875;2
5.431168;8.472387;2
5.512969;6.583099;2
5.223218;6.401198;2
5.089579;7.144633;2
5.229086;8.002539;2
5.101077;9.498747;2
5.483278;9.198926;2
5.238041;8.872839;2
4.582445;12.138247;2
4.206597;3.871821;2
5.721612;9.076808;2
4.976357;6.414645;2
4.889557;6.891008;2
4.846133;11.380134;2
5.257730;7.291432;2
6.151347;4.085448;2
4.766034;7.761094;2
5.139171;8.704559;2
4.581706;8.650086;2
5.276512;7.121668;2
6.233016;4.037460;2
5.292535;5.637067;2
8.528708;3.184409;3
8.128628;5.404325;3
14.245390;1.702423;3
10.967304;8.776011;3
13.257442;3.045071;3
14.487542;4.522492;3
7.679029;5.517452;3
11.780260;5.204712;3
10.901939;5.040933;3
9.129246;4.651472;3
14.595322;1.394258;3
6.181558;3.362016;3
17.719961;2.043077;3
0.940248;6.272002;3
10.360649;4.596329;3
8.996705;4.276436;3
10.411387;4.422615;3
8.182150;3.150997;3
8.848266;3.756270;3
3.458120;4.668595;3
12.491807;4.056722;3
15.552633;4.926942;3
11.506802;2.378696;3
8.768698;5.307384;3
5.332279;3.480291;3
12.193213;5.165371;3
13.777684;3.081714;3
9.463121;3.321213;3
8.838790;5.455822;3
3.135522;3.215490;3
3.259124;6.103721;3
3.692457;5.113627;3
9.734214;2.603533;3
8.732613;6.672858;3
13.416791;1.524538;3
8.509226;2.161165;3
7.307670;2.656237;3
10.027742;5.062318;3
4.774289;1.869866;3
12.300023;2.741814;3
7.010767;5.076157;3
8.612263;3.307045;3
13.793546;8.324703;3
6.826358;3.873889;3
12.068603;2.339628;3
11.579480;3.833474;3
9.730834;2.075660;3
9.353963;6.876993;3
11.871309;2.760975;3
7.937196;4.862695;3
14.945073;4.560888;3
11.680703;1.595772;3
8.207530;2.924280;3
4.894062;3.969940;3
14.640061;4.584874;3
12.072982;3.641960;3
8.253924;3.330307;3
13.743916;8.002843;3
11.094980;3.974111;3
6.359146;3.412811;3
9.860543;4.091385;3
11.250084;4.564519;3
8.291078;3.743364;3
10.269283;3.170189;3
8.798929;7.038003;3
8.523165;2.312041;3
8.692702;5.188540;3
8.417535;6.531987;3
6.210441;5.081820;3
15.508040;3.067824;3
11.075308;-0.161147;3
12.266249;3.191769;3
8.493580;4.617586;3
10.416276;4.440460;3
6.796282;1.971747;3
12.482897;7.056453;3
14.326328;4.419297;3
15.503559;3.197940;3
10.015506;2.822228;3
13.721854;1.023668;3
9.886361;3.666110;3
6.358051;2.537278;3
14.711716;5.018693;3
11.985474;4.170456;3
11.276860;5.570008;3
10.275653;7.463125;3
11.894799;5.624827;3
10.044876;5.860403;3
9.848865;0.939283;3
11.827293;3.188021;3
10.885988;4.599820;3
15.453241;0.850563;3
15.161241;1.785320;3
1.984670;2.195609;3
10.439830;2.028369;3
6.140438;7.192154;3
16.986955;4.267524;3
7.444575;2.329823;3
12.355931;3.769554;3
8.233084;1.149639;3
    </textarea>
    <div>
      <label for="means">Grupper</label>
      <input id="means" value="3"/>
    </div>
    <button onclick="setup()">
      Genererer k-means clustering
    </button>
  </div>
  <div>
    <canvas id="canvas" height="400" width="400"></canvas>
    <p>Score: <span id="score"></span></p>
  </div>
</div>

<script>
  var canvas;
  var ctx;
  var height = 400;
  var width = 400;
  var data = [];
  var means = [];
  var assignments = [];
  var dataExtremes;
  var dataRange;
  var drawDelay = 2000;
  var score = 0;

  function setup() {

    console.log(data);
    console.log(means);
    console.log(assignments);
    dataRange = null;
    dataExtremes = null;
    means = [];
    data = [];
    assignments = [];
    score = 0;

    canvas = document.getElementById('canvas');
    ctx = canvas.getContext('2d');

    data = convertTextToData();
    console.log(data);
    dataExtremes = getDataExtremes();
    dataRange = getDataRanges(dataExtremes);
    means = initMeans(document.getElementById('means').value);

    makeAssignments();
    draw();

    setTimeout(run, drawDelay);
  }

  function convertTextToData() {
    var value = document.getElementById('data').value;
    value = value.split("\n").filter(d => d.includes(';')).map(d => d.split(";").map(d => +d));
    return value;
  }

  function getDataRanges(extremes) {
    var ranges = [];

    for (var dimension in extremes) {
      ranges[dimension] = extremes[dimension].max - extremes[dimension].min;
    }

    return ranges;

  }

  function getDataExtremes() {

    var extremes = [];

    for (var i in data) {
      var point = data[i];

      for (var dimension in point) {
        if (!extremes[dimension]) {
          extremes[dimension] = {min: 1000, max: 0};
        }

        if (point[dimension] < extremes[dimension].min) {
          extremes[dimension].min = point[dimension];
        }

        if (point[dimension] > extremes[dimension].max) {
          extremes[dimension].max = point[dimension];
        }
      }
    }
    console.log(extremes);

    return extremes;

  }

  function initMeans(k) {

    if (!k) {
      k = 3;
    }

    while (k--) {
      var mean = [];

      for (var dimension in dataExtremes) {
        mean[dimension] = dataExtremes[dimension].min + (Math.random() * dataRange[dimension]);
      }

      means.push(mean);
    }

    return means;

  };

  function makeAssignments() {

    for (var i in data) {
      var point = data[i];
      var distances = [];

      for (var j in means) {
        var mean = means[j];
        var sum = 0;

        for (var dimension in point) {
          var difference = point[dimension] - mean[dimension];
          difference *= difference;
          sum += difference;
        }

        distances[j] = Math.sqrt(sum);
      }

      assignments[i] = distances.indexOf(Math.min.apply(null, distances));
    }

  }

  function moveMeans() {

    makeAssignments();

    var sums = Array(means.length);
    var counts = Array(means.length);
    var moved = false;

    for (var j in means) {
      counts[j] = 0;
      sums[j] = Array(means[j].length);
      for (var dimension in means[j]) {
        sums[j][dimension] = 0;
      }
    }

    for (var point_index in assignments) {
      var mean_index = assignments[point_index];
      var point = data[point_index];
      var mean = means[mean_index];

      counts[mean_index]++;

      for (var dimension in mean) {
        sums[mean_index][dimension] += point[dimension];
      }
    }

    for (var mean_index in sums) {
      if (0 === counts[mean_index]) {
        sums[mean_index] = means[mean_index];

        for (var dimension in dataExtremes) {
          sums[mean_index][dimension] = dataExtremes[dimension].min + (Math.random() * dataRange[dimension]);
        }
        continue;
      }

      for (var dimension in sums[mean_index]) {
        sums[mean_index][dimension] /= counts[mean_index];
      }
    }

    if (means.toString() !== sums.toString()) {
      moved = true;
    }

    means = sums;

    return moved;

  }

  function run() {

    var moved = moveMeans();
    draw();

    if (moved) {
      setTimeout(run, drawDelay);
    }

  }

  function draw() {

    score = 0;
    ctx.clearRect(0, 0, width, height);

    ctx.globalAlpha = 0.3;

    // Draw grid
    for (var x = (Math.abs(dataExtremes[0].min) - Math.floor(Math.abs(dataExtremes[0].min))) * (width / dataRange[0]); x < width; x += (width / (dataRange[0] + 2))) {
      ctx.moveTo(x, 0);
      ctx.lineTo(x, 400);
      ctx.strokeStyle = "#ddd";
      ctx.stroke();
    }

    for (var y = (Math.abs(dataExtremes[1].min) - Math.floor(Math.abs(dataExtremes[1].min))) * (width / dataRange[1]); y < height; y += (height / (dataRange[1] + 2))) {
      ctx.moveTo(0, y);
      ctx.lineTo(400, y);
      ctx.strokeStyle = "#ddd";
      ctx.stroke();
    }
    ctx.textBaseline = "top";
    ctx.textAlign = "left";
    ctx.fillText("( " + (dataExtremes[0].min - 1) + " , " + (dataExtremes[1].min - 1) +" )", 8, 5);
    ctx.textAlign = "right";
    ctx.textBaseline = "bottom";

    ctx.fillRect(0, 0, 3, 3);
    ctx.fillRect(397, 397, 3, 3);


    ctx.fillText("( " + (dataExtremes[0].max + 1) + " , " + (dataExtremes[1].max + 1) + " )", 392, 390);

    // Draw lines
    for (var point_index in assignments) {
      var mean_index = assignments[point_index];
      var point = data[point_index];
      var mean = means[mean_index];

      score +=  Math.sqrt(Math.abs(Math.pow(point[0]-mean[0], 2) + Math.pow(point[1]-mean[1], 2)));

      ctx.save();

      ctx.strokeStyle = 'blue';
      ctx.beginPath();
      ctx.moveTo(
        (point[0] - dataExtremes[0].min + 1) * (width / (dataRange[0] + 2)),
        (point[1] - dataExtremes[1].min + 1) * (height / (dataRange[1] + 2))
      );
      ctx.lineTo(
        (mean[0] - dataExtremes[0].min + 1) * (width / (dataRange[0] + 2)),
        (mean[1] - dataExtremes[1].min + 1) * (height / (dataRange[1] + 2))
      );
      ctx.stroke();
      ctx.closePath();

      ctx.restore();
    }
    ctx.globalAlpha = 1;

    // Draw dots
    for (var i in data) {
      ctx.save();

      var point = data[i];

      var x = (point[0] - dataExtremes[0].min + 1) * (width / (dataRange[0] + 2));
      var y = (point[1] - dataExtremes[1].min + 1) * (height / (dataRange[1] + 2));

      ctx.strokeStyle = '#333333';
      ctx.translate(x, y);
      ctx.beginPath();
      ctx.arc(0, 0, 5, 0, Math.PI * 2, true);
      ctx.stroke();
      ctx.closePath();

      ctx.restore();
    }

    // Draw center of means
    for (var i in means) {
      ctx.save();

      var point = means[i];

      var x = (point[0] - dataExtremes[0].min + 1) * (width / (dataRange[0] + 2));
      var y = (point[1] - dataExtremes[1].min + 1) * (height / (dataRange[1] + 2));

      ctx.fillStyle = 'green';
      ctx.translate(x, y);
      ctx.beginPath();
      ctx.arc(0, 0, 5, 0, Math.PI * 2, true);
      ctx.fill();
      ctx.closePath();

      ctx.restore();

    }

    document.getElementById("score").innerText = score;

  }
</script>

</body>
</html>